<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ショート学習アプリ（完成版）</title>
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2a2a2a;
            --text-color: #f0f0f0;
            --accent-color: #ff4757;
            --border-color: #444;
            --ai-accent-color: #4f8dff;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--primary-bg);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative
        }

        .hidden {
            display: none !important
        }

        #initial-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
            background: var(--primary-bg)
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ai-accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite
        }

        .loader.small {
            width: 18px;
            height: 18px;
            border-width: 2px
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            height: 48px
        }

        .topic-title {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color)
        }

        .tab-item {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #888;
            font-weight: 700;
            position: relative
        }

        .tab-item.active {
            color: var(--text-color)
        }

        .tab-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 3px;
            background: var(--accent-color)
        }

        #search-home-panel {
            padding: 20px;
            box-sizing: border-box;
            height: 100%
        }

        .search-box {
            display: flex;
            margin-bottom: 20px
        }

        #search-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--secondary-bg);
            color: var(--text-color)
        }

        #search-button {
            padding: 10px 18px;
            border-radius: 20px;
            border: none;
            background: var(--ai-accent-color);
            color: #fff;
            cursor: pointer;
            margin-left: 8px
        }

        .history-title {
            font-size: .9rem;
            color: #888;
            margin: 0 0 10px
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow: auto
        }

        .history-item {
            background: var(--secondary-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer
        }

        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden
        }

        .content-panel {
            position: absolute;
            inset: 0;
            visibility: hidden;
            opacity: 0;
            transition: opacity .25s, visibility .25s
        }

        .content-panel.active {
            visibility: visible;
            opacity: 1
        }

        .card-container {
            width: 100%;
            height: 100%;
            position: relative
        }

        .card {
            position: absolute;
            inset: 0;
            background: var(--primary-bg);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: transform .3s;
            display: flex;
            flex-direction: column
        }

        .card.previous {
            transform: translateY(-100%)
        }

        .card.current {
            transform: translateY(0);
            z-index: 10
        }

        .card.next {
            transform: translateY(100%)
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px
        }

        .card-point {
            font-weight: 600;
            color: #c0c0c0;
            margin-bottom: 12px
        }

        .card-detail {
            color: #a0a0a0;
            line-height: 1.6;
            margin-bottom: 12px
        }

        .card-code {
            background: var(--secondary-bg);
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 12px;
            flex: 1
        }

        .card-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: auto
        }

        .ai-explain-button {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 8px 12px;
            border: none;
            color: var(--text-color);
            cursor: pointer
        }

        .like-button {
            background: none;
            border: none;
            cursor: pointer
        }

        .empty-placeholder {
            text-align: center;
            color: #888;
            padding-top: 40px
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity .3s, visibility .3s;
            z-index: 1000
        }

        .modal-backdrop.visible {
            visibility: visible;
            opacity: 1
        }

        .modal-content {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            overflow: auto
        }

        /* debug (デフォルト非表示) */
        #debug-panel {
            position: fixed;
            right: 12px;
            bottom: 12px;
            width: 360px;
            max-height: 40vh;
            overflow: auto;
            background: #0b0b0b;
            color: #eee;
            border: 1px solid #222;
            padding: 8px;
            font-size: 12px;
            z-index: 10001;
            display: none
        }

        #debug-panel pre {
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            font-family: monospace;
            font-size: 11px
        }

        #debug-toggle {
            position: fixed;
            right: 12px;
            bottom: calc(40vh + 28px);
            z-index: 10002;
            background: #222;
            color: #fff;
            border: 1px solid #333;
            padding: 6px 8px;
            cursor: pointer;
            display: none
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* ===== 設定 ===== */
        const DEBUG_BYPASS_AI = false;       // 完成版: false
        const DEBUG_SHOW_RAW_RESPONSE = false;

        // ここはそのまま使える（あなたのURL制限つきキーを直書き）
        const LLM_API_KEY = "AIzaSyAGp5utrpKieGaJoJ59qbQs-7X9GS0wbDk";

        const firebaseConfig = {
            apiKey: "AIzaSyD81oPn5HUBGmkHWId2KVpPdbGvJ9St_og",
            authDomain: "shortstudio-59078.firebaseapp.com",
            projectId: "shortstudio-59078",
            storageBucket: "shortstudio-59078.firebasestorage.app",
            messagingSenderId: "366522463743",
            appId: "1:366522463743:web:c782685bf99baf24aaa3ca",
            measurementId: "G-G6X5PXXP2S"
        };

        /* ===== 共有DOM ===== */
        const dom = {
            initialLoader: document.getElementById('initial-loader'),
            searchHomePanel: document.getElementById('search-home-panel'),
            mainContent: document.getElementById('main-content'),
            searchInput: document.getElementById('search-input'),
            searchButton: document.getElementById('search-button'),
            historyList: document.getElementById('history-list'),
            homeIcon: document.getElementById('home-icon'),
            topicTitle: document.getElementById('topic-title'),
            fetchingIndicator: document.getElementById('fetching-indicator'),
            tabs: document.querySelectorAll('.tab-item'),
            panels: document.querySelectorAll('.content-panel'),
            cardContainer: document.getElementById('card-container'),
            likesPanel: document.getElementById('likes-panel'),
            playlistListView: document.getElementById('playlist-list-view'),
            playlistCardsView: document.getElementById('playlist-cards-view'),
            aiModal: document.getElementById('ai-modal'),
            aiModalClose: document.getElementById('ai-modal-close'),
            aiModalBody: document.getElementById('ai-modal-body'),
            playlistModal: document.getElementById('playlist-modal'),
            playlistModalClose: document.getElementById('playlist-modal-close'),
            playlistModalList: document.getElementById('playlist-modal-list'),
            newPlaylistInput: document.getElementById('new-playlist-input'),
            createPlaylistBtn: document.getElementById('create-playlist-btn'),
            debugPanel: document.getElementById('debug-panel'),
            debugPre: document.getElementById('debug-pre'),
            debugToggle: document.getElementById('debug-toggle'),
        };

        /* ===== 状態 ===== */
        const state = {
            cardIds: [], allCards: new Map(), currentIndex: 0,
            playlists: new Map(), activeTab: 'feed', isFetching: false,
            currentTopic: 'おすすめ', userId: null, db: null, auth: null,
            searchHistory: []
        };
        const ALL_CARDS_KEY = 'sl_allCards_v9';
        const SEARCH_HISTORY_KEY = 'sl_searchHistory_v9';
        let localStorageAvailable = false;
        const app = initializeApp(firebaseConfig);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const db = getFirestore(app);
        const auth = getAuth(app);

        /* ===== ユーティリティ ===== */
        function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function setDebugRaw(s) { if (!DEBUG_SHOW_RAW_RESPONSE) return; dom.debugPre.textContent = String(s).slice(0, 10000); }
        function hideInitialLoader() { dom.initialLoader.style.opacity = '0'; setTimeout(() => dom.initialLoader.style.display = 'none', 500); }
        function checkLocalStorage() { try { localStorage.setItem('t', 't'); localStorage.removeItem('t'); localStorageAvailable = true; } catch { localStorageAvailable = false; } }
        function loadState() {
            if (!localStorageAvailable) return;
            const all = localStorage.getItem(ALL_CARDS_KEY); if (all) state.allCards = new Map(JSON.parse(all));
            const hist = localStorage.getItem(SEARCH_HISTORY_KEY); if (hist) state.searchHistory = JSON.parse(hist);
        }
        function saveState() {
            if (!localStorageAvailable) return;
            try {
                localStorage.setItem(ALL_CARDS_KEY, JSON.stringify(Array.from(state.allCards.entries())));
                localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(state.searchHistory));
            } catch { }
        }

        // JSON配列だけ抜いてパース
        function safeParseJsonArray(maybeJson) {
            if (Array.isArray(maybeJson)) return maybeJson;
            let s = String(maybeJson || '').trim();
            s = s.replace(/^```json\s*/i, '').replace(/```$/i, '').trim();
            const m = s.match(/\[[\s\S]*\]/);
            if (!m) throw new Error('JSON配列が見つかりません');
            return JSON.parse(m[0]);
        }

        /* ===== LLM 呼び出し（直叩き・フォールバック付き）===== */
        async function callLLM(prompt, schema = null) {
            if (DEBUG_BYPASS_AI) {
                const sample = JSON.stringify([
                    { title: "サンプル: 要点整理", point: "PFCを意識", detail: "たんぱく質/脂質/炭水化物のバランス", code: "" },
                    { title: "サンプル: 睡眠のコツ", point: "就寝1時間前は画面オフ", detail: "入眠を妨げる要因を減らす", code: "" }
                ]);
                setDebugRaw("DEBUG_BYPASS_AI\n" + sample);
                return sample;
            }

            const models = [
                "gemini-2.5-flash-preview-05-20",
                "gemini-1.5-flash"
            ];

            const payloadBase = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (schema) payloadBase.generationConfig = { responseMimeType: "application/json", responseSchema: schema };

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            try {
                let lastErr;
                for (const model of models) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${LLM_API_KEY}`;
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payloadBase),
                            signal: controller.signal
                        });
                        const raw = await res.text();
                        setDebugRaw(`[${model}] HTTP ${res.status}\n${raw.slice(0, 5000)}`);
                        if (!res.ok) { lastErr = new Error(`[${model}] ${res.status} ${raw.slice(0, 300)}`); continue; }
                        let json; try { json = JSON.parse(raw); } catch { throw new Error(`[${model}] 非JSON応答`); }
                        const part = json?.candidates?.[0]?.content?.parts?.find(p => typeof p.text === 'string');
                        if (!part) throw new Error(`[${model}] 応答に text がありません`);
                        return part.text;
                    } catch (e) {
                        lastErr = e;
                        // 次のモデルへ
                    }
                }
                throw lastErr || new Error('LLM呼び出しに失敗しました');
            } finally {
                clearTimeout(timeout);
            }
        }

        /* ===== カード生成 ===== */
        async function generateCardsFromAI(count, topic = '全般') {
            const prompt =
                `あなたは専門家です。モバイル学習アプリ向けに、トピック「${topic}」の学習カードを${count}個、` +
                `JSON配列で生成してください。各要素は { "title": "...", "point": "...", "detail": "...", "code": "..." } を含めること。`;
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        title: { type: "STRING" }, point: { type: "STRING" }, detail: { type: "STRING" }, code: { type: "STRING" }
                    },
                    required: ["title", "point"]
                }
            };
            const resultText = await callLLM(prompt, schema);
            setDebugRaw('RAW:\n' + String(resultText).slice(0, 5000));

            let arr;
            try {
                arr = safeParseJsonArray(resultText);
            } catch (parseErr) {
                // 失敗してもUIが動くようフォールバック
                arr = [
                    { title: `フォールバック: ${topic} 1`, point: '生成失敗のため暫定', detail: 'レスポンスのパースに失敗', code: '' },
                    { title: `フォールバック: ${topic} 2`, point: '同上', detail: '', code: '' }
                ];
            }

            const now = Date.now();
            return arr.map((raw, i) => {
                const title = String(raw.title || raw.heading || `学習カード ${i + 1}`).slice(0, 120);
                const point = String(raw.point || raw.summary || '要点').slice(0, 200);
                const detail = raw.detail ? String(raw.detail) : '';
                const code = raw.code ? String(raw.code) : '';
                return { id: `${topic}-${now}-${i}`, title, point, detail, code };
            });
        }

        /* ===== 表示系 ===== */
        function updateTopicTitle() { dom.topicTitle.textContent = state.currentTopic === 'おすすめ' ? 'ショート学習' : `「${state.currentTopic}」の学習`; }
        function updateActiveTab() {
            dom.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === state.activeTab));
            dom.panels.forEach(p => p.classList.toggle('active', p.id.startsWith(state.activeTab)));
            if (state.activeTab === 'likes') renderPlaylists();
        }
        function renderSearchHistory() {
            dom.historyList.innerHTML = '';
            state.searchHistory.forEach(term => {
                const li = document.createElement('li'); li.className = 'history-item'; li.textContent = term;
                li.addEventListener('click', () => handleSearch(term));
                dom.historyList.appendChild(li);
            });
        }
        function switchView(view) {
            if (view === 'search') { dom.searchHomePanel.classList.remove('hidden'); dom.mainContent.classList.add('hidden'); renderSearchHistory(); }
            else { dom.searchHomePanel.classList.add('hidden'); dom.mainContent.classList.remove('hidden'); }
        }
        function showError(message, showRetry = false) {
            hideInitialLoader();
            const retry = showRetry ? `<button id="error-retry-btn" style="margin-top:12px;background:var(--ai-accent-color);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">検索に戻る</button>` : '';
            dom.cardContainer.innerHTML = `<div class="card current" style="justify-content:center;align-items:center"><div style="max-width:420px;text-align:center"><p>${escapeHtml(String(message))}</p>${retry}</div></div>`;
            if (showRetry) { document.getElementById('error-retry-btn').addEventListener('click', () => switchView('search')); }
            switchView('main');
        }
        function renderCurrentCardView() {
            dom.cardContainer.innerHTML = '';
            const currentId = state.cardIds[state.currentIndex];
            if (!currentId) {
                dom.cardContainer.innerHTML = `<div class="card current" style="justify-content:center;align-items:center"><p class="empty-placeholder">カードがありません。検索してみてください。</p></div>`;
                return;
            }
            const prevId = state.cardIds[state.currentIndex - 1];
            const nextId = state.cardIds[state.currentIndex + 1];
            if (prevId) dom.cardContainer.appendChild(createCardElement(state.allCards.get(prevId), 'previous'));
            dom.cardContainer.appendChild(createCardElement(state.allCards.get(currentId), 'current'));
            if (nextId) dom.cardContainer.appendChild(createCardElement(state.allCards.get(nextId), 'next'));
        }
        function createCardElement(cardData, pos) {
            if (!cardData) return document.createDocumentFragment();
            const el = document.createElement('div'); el.className = `card ${pos}`; el.dataset.id = cardData.id || '';
            const aiBtn = cardData.code ? `<button class="ai-explain-button" data-code="${escapeHtml(cardData.code)}">✨ AIで詳しく解説</button>` : '';
            el.innerHTML = `
      <div class="card-title">${escapeHtml(cardData.title)}</div>
      <div class="card-point">${escapeHtml(cardData.point)}</div>
      ${cardData.detail ? `<div class="card-detail">${escapeHtml(cardData.detail)}</div>` : ''}
      ${cardData.code ? `<pre class="card-code"><code>${escapeHtml(cardData.code)}</code></pre>` : ''}
      <div class="card-actions">
        ${aiBtn}
        <button class="like-button" data-id="${cardData.id}" aria-label="プレイリストに追加">
          <svg class="like-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
      </div>`;
            const likeBtn = el.querySelector('.like-button'); if (likeBtn) likeBtn.addEventListener('click', handleLikeClick);
            const explainBtn = el.querySelector('.ai-explain-button'); if (explainBtn) explainBtn.addEventListener('click', handleExplainClick);
            return el;
        }
        function renderPlaylists() {
            dom.playlistListView.innerHTML = ''; dom.playlistCardsView.classList.add('hidden'); dom.playlistListView.classList.remove('hidden');
            if (state.playlists.size === 0) {
                dom.playlistListView.innerHTML = '<div class="empty-placeholder"><p>プレイリストがありません。</p></div>'; return;
            }
            state.playlists.forEach((cardIds, name) => {
                const item = document.createElement('div'); item.className = 'playlist-item';
                item.innerHTML = `<div style="font-weight:700">${escapeHtml(name)}</div><div style="color:#c0c0c0">${cardIds.size} 件のカード</div>`;
                item.addEventListener('click', () => renderPlaylistCards(name));
                dom.playlistListView.appendChild(item);
            });
        }
        function renderPlaylistCards(name) {
            dom.playlistListView.classList.add('hidden'); dom.playlistCardsView.classList.remove('hidden'); dom.playlistCardsView.innerHTML = '';
            const header = document.createElement('div'); header.style.display = 'flex'; header.style.alignItems = 'center'; header.style.marginBottom = '12px';
            header.innerHTML = `<button class="back-to-playlists" style="background:none;border:none;cursor:pointer;margin-right:10px">◀</button><h3 style="margin:0">${escapeHtml(name)}</h3>`;
            header.querySelector('.back-to-playlists').addEventListener('click', renderPlaylists);
            dom.playlistCardsView.appendChild(header);
            const ids = state.playlists.get(name);
            if (ids && ids.size > 0) {
                ids.forEach(cid => {
                    const c = state.allCards.get(cid); if (!c) return;
                    const item = document.createElement('div'); item.className = 'liked-item';
                    item.innerHTML = `<div style="font-weight:700">${escapeHtml(c.title)}</div><div style="color:#c0c0c0">${escapeHtml(c.point)}</div>`;
                    item.addEventListener('click', () => handleLikedItemClick(cid));
                    dom.playlistCardsView.appendChild(item);
                });
            }
        }

        /* ===== ハンドラ ===== */
        function handleTabClick(e) { state.activeTab = e.currentTarget.dataset.tab; updateActiveTab(); }
        function handleLikeClick(e) {
            e.stopPropagation();
            const cardId = e.currentTarget.dataset.id;
            dom.playlistModal.dataset.cardId = cardId;
            renderPlaylistModal();
            dom.playlistModal.classList.add('visible');
        }
        function renderPlaylistModal() {
            const cardId = dom.playlistModal.dataset.cardId || '';
            dom.playlistModalList.innerHTML = '';
            if (state.playlists.size === 0) {
                dom.playlistModalList.innerHTML = '<div class="empty-placeholder">プレイリストがありません。新規作成してください。</div>';
            }
            state.playlists.forEach((cardIds, name) => {
                const isChecked = cardIds.has(cardId);
                const row = document.createElement('div'); row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.padding = '6px 0';
                row.innerHTML = `<input type="checkbox" id="pl-${escapeHtml(name)}" ${isChecked ? 'checked' : ''} /><label for="pl-${escapeHtml(name)}" style="margin-left:8px">${escapeHtml(name)}</label>`;
                row.querySelector('input').addEventListener('change', (ev) => updateCardInPlaylist(cardId, name, ev.target.checked));
                dom.playlistModalList.appendChild(row);
            });
        }
        function updateCardInPlaylist(cardId, playlistName, shouldBeIn) {
            const pl = state.playlists.get(playlistName); if (!pl) return; if (shouldBeIn) pl.add(cardId); else pl.delete(cardId); savePlaylists();
        }
        function createNewPlaylist() {
            const name = (dom.newPlaylistInput.value || '').trim(); if (!name) return;
            if (!state.playlists.has(name)) state.playlists.set(name, new Set());
            dom.newPlaylistInput.value = ''; renderPlaylistModal(); savePlaylists();
        }
        function handleLikedItemClick(cardId) {
            const topic = (cardId || '').split('-')[0];
            const topicCards = Array.from(state.allCards.values()).filter(c => c.id && c.id.startsWith(topic));
            const ids = topicCards.map(c => c.id);
            const idx = ids.indexOf(cardId);
            if (idx !== -1) {
                state.cardIds = ids; state.currentTopic = topic; state.activeTab = 'feed';
                navigateTo(idx, true); updateActiveTab(); updateTopicTitle(); switchView('main');
            }
        }
        async function handleExplainClick(e) {
            e.stopPropagation();
            const code = e.currentTarget.dataset.code;
            dom.aiModalBody.innerHTML = '<div class="loader"></div>';
            dom.aiModal.classList.add('visible');
            const prompt = `以下のコードを初心者にも分かるように、各行の役割を具体的に解説してください。\n\n\`\`\`javascript\n${code}\n\`\`\``;
            try {
                const text = await callLLM(prompt);
                dom.aiModalBody.textContent = text || '（応答が空でした）';
            } catch (err) {
                dom.aiModalBody.textContent = 'エラー: ' + String(err.message || err);
            }
        }

        async function handleSearch(topic, isInitial = false) {
            state.isFetching = true;
            if (!isInitial) {
                switchView('main');
                dom.fetchingIndicator.classList.add('visible');
                dom.cardContainer.innerHTML = `<div class="card current" style="justify-content:center;align-items:center"><div class="loader"></div></div>`;
            }
            if (!state.searchHistory.includes(topic)) {
                state.searchHistory.unshift(topic); if (state.searchHistory.length > 10) state.searchHistory.pop();
            }
            try {
                const cards = await generateCardsFromAI(10, topic);
                if (!cards || cards.length === 0) throw new Error('No cards generated');
                cards.forEach(c => state.allCards.set(c.id, c));
                state.cardIds = cards.map(c => c.id);
                state.currentIndex = 0; state.currentTopic = topic; saveState(); startApp();
            } catch (err) {
                showError(`学習カードの生成に失敗: ${String(err.message || err)}`, true);
            } finally {
                state.isFetching = false;
                if (isInitial) hideInitialLoader();
                dom.fetchingIndicator.classList.remove('visible');
            }
        }

        async function navigateTo(index, fromTab = false) {
            if (index < 0) { snapCardsBack(); return; }
            if (index >= state.cardIds.length) {
                if (!state.isFetching) await addMoreCards();
                if (index >= state.cardIds.length) { snapCardsBack(); return; }
            }
            if (fromTab) {
                state.currentIndex = index; state.activeTab = 'feed'; updateActiveTab(); updateTopicTitle(); renderCurrentCardView(); saveState(); return;
            }
            if (index === state.currentIndex) return;
            const dir = index > state.currentIndex ? 1 : -1;
            const cur = dom.cardContainer.querySelector('.card.current');
            if (dir === 1) {
                const next = dom.cardContainer.querySelector('.card.next'); if (cur) cur.className = 'card previous'; if (next) next.className = 'card current';
            } else {
                const prev = dom.cardContainer.querySelector('.card.previous'); if (cur) cur.className = 'card next'; if (prev) prev.className = 'card current';
            }
            state.currentIndex = index;
            setTimeout(() => { renderCurrentCardView(); saveState(); if (!state.isFetching && state.currentIndex >= state.cardIds.length - 2) addMoreCards(); }, 300);
        }
        function snapCardsBack() {
            document.querySelectorAll('.card').forEach(c => { if (c) c.style.transition = 'transform .3s'; });
            const cur = dom.cardContainer.querySelector('.card.current'); if (cur) cur.style.transform = 'translateY(0)';
            const prev = dom.cardContainer.querySelector('.card.previous'); if (prev) prev.style.transform = 'translateY(-100%)';
            const next = dom.cardContainer.querySelector('.card.next'); if (next) next.style.transform = 'translateY(100%)';
        }
        async function addMoreCards() {
            if (state.isFetching) return;
            state.isFetching = true; dom.fetchingIndicator.classList.add('visible');
            try {
                const more = await generateCardsFromAI(3, state.currentTopic);
                if (more && more.length > 0) {
                    more.forEach(c => state.allCards.set(c.id, c));
                    state.cardIds.push(...more.map(c => c.id));
                    saveState();
                }
            } catch { } finally {
                state.isFetching = false; dom.fetchingIndicator.classList.remove('visible');
            }
        }

        async function savePlaylists() {
            if (!state.userId) return;
            const playlistsDocRef = doc(db, `artifacts/${appId}/users/${state.userId}/playlists/data`);
            try {
                const obj = {}; state.playlists.forEach((ids, name) => obj[name] = Array.from(ids));
                await setDoc(playlistsDocRef, obj);
            } catch (e) { /* noop */ }
        }

        /* ===== イベント結線 ===== */
        function setupEventListeners() {
            dom.tabs.forEach(t => t.addEventListener('click', handleTabClick));
            dom.homeIcon.addEventListener('click', () => switchView('search'));
            dom.searchButton.addEventListener('click', () => { const q = (dom.searchInput.value || '').trim(); if (q) handleSearch(q); });
            dom.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') dom.searchButton.click(); });
            dom.aiModalClose.addEventListener('click', () => dom.aiModal.classList.remove('visible'));
            dom.playlistModalClose.addEventListener('click', () => dom.playlistModal.classList.remove('visible'));
            dom.createPlaylistBtn.addEventListener('click', createNewPlaylist);

            // スワイプ
            let startY = 0, startX = 0, isDragging = false; const swipeThreshold = 50, angleThreshold = 20;
            dom.cardContainer.addEventListener('pointerdown', e => { if (state.cardIds.length === 0) return; startY = e.clientY; startX = e.clientX; isDragging = true; document.querySelectorAll('.card').forEach(c => { if (c) c.style.transition = 'none'; }); });
            dom.cardContainer.addEventListener('pointermove', e => { if (!isDragging) return; const dy = e.clientY - startY; const c = dom.cardContainer.querySelector('.card.current'); const p = dom.cardContainer.querySelector('.card.previous'); const n = dom.cardContainer.querySelector('.card.next'); if (c) c.style.transform = `translateY(${dy}px)`; if (p) p.style.transform = `translateY(calc(-100% + ${dy}px))`; if (n) n.style.transform = `translateY(calc(100% + ${dy}px))`; });
            const end = e => { if (!isDragging) return; isDragging = false; const dy = e.clientY - startY; const dx = e.clientX - startX; const angle = Math.abs(Math.atan2(dx, dy) * 180 / Math.PI); if (Math.abs(90 - angle) > (90 - angleThreshold)) { if (Math.abs(dy) > swipeThreshold) { if (dy < 0) navigateTo(state.currentIndex + 1); else navigateTo(state.currentIndex - 1); } else snapCardsBack(); } else snapCardsBack(); };
            dom.cardContainer.addEventListener('pointerup', end); dom.cardContainer.addEventListener('pointerleave', end);

            // キー/ホイール
            window.addEventListener('keydown', e => { if (state.activeTab !== 'feed') return; if (e.key === 'ArrowUp') navigateTo(state.currentIndex - 1); else if (e.key === 'ArrowDown') navigateTo(state.currentIndex + 1); });
            let isWheeling = false; window.addEventListener('wheel', e => { if (state.activeTab !== 'feed' || isWheeling) return; isWheeling = true; if (e.deltaY > 0) navigateTo(state.currentIndex + 1); else if (e.deltaY < 0) navigateTo(state.currentIndex - 1); setTimeout(() => isWheeling = false, 350); }, { passive: false });
        }

        /* ===== Firebase init ===== */
        function setupFirebase() {
            return new Promise(resolve => {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        state.userId = user.uid;
                        const playlistsDocRef = doc(db, `artifacts/${appId}/users/${state.userId}/playlists/data`);
                        onSnapshot(playlistsDocRef, snap => {
                            state.playlists.clear();
                            if (snap.exists()) {
                                const data = snap.data(); for (const name in data) { state.playlists.set(name, new Set(data[name])); }
                            }
                            if (state.activeTab === 'likes') renderPlaylists();
                            if (dom.initialLoader.style.display !== 'none') { hideInitialLoader(); switchView('search'); }
                            resolve();
                        });
                    }
                });
                signInAnonymously(auth).catch(() => { hideInitialLoader(); switchView('search'); resolve(); });
            });
        }

        /* ===== 起動 ===== */
        function startApp() { updateTopicTitle(); renderCurrentCardView(); updateActiveTab(); }
        async function init() {
            checkLocalStorage(); loadState(); setupEventListeners(); await setupFirebase();
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</head>

<body>
    <div class="app-container">
        <div id="initial-loader">
            <div class="loader"></div>
            <p style="margin-top:14px;color:var(--ai-accent-color);font-weight:700">アプリを起動中...</p>
        </div>

        <div id="search-home-panel" class="hidden">
            <div class="search-box">
                <input id="search-input" placeholder="何を学びますか？" />
                <button id="search-button">検索</button>
            </div>
            <h2 class="history-title">検索履歴</h2>
            <ul id="history-list" class="history-list"></ul>
        </div>

        <div id="main-content" class="hidden">
            <header class="header">
                <div class="top-bar">
                    <svg id="home-icon" class="action-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9 22 9 12 15 12 15 22" />
                    </svg>
                    <div id="topic-title" class="topic-title"></div>
                    <div id="fetching-indicator">
                        <div class="loader small"></div>
                    </div>
                </div>
                <nav class="tabs">
                    <div class="tab-item active" data-tab="feed">学習</div>
                    <div class="tab-item" data-tab="likes">プレイリスト</div>
                </nav>
            </header>

            <main class="content-area">
                <section id="feed-panel" class="content-panel active">
                    <div id="card-container" class="card-container"></div>
                </section>
                <section id="likes-panel" class="content-panel">
                    <div id="playlist-list-view"></div>
                    <div id="playlist-cards-view" class="hidden"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- AI modal -->
    <div id="ai-modal" class="modal-backdrop">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h3 style="margin:0">✨ AIによるコード解説</h3>
                <button id="ai-modal-close"
                    style="background:none;border:none;color:var(--text-color);font-size:20px;cursor:pointer">&times;</button>
            </div>
            <div id="ai-modal-body" style="line-height:1.6"></div>
        </div>
    </div>

    <!-- Playlist modal -->
    <div id="playlist-modal" class="modal-backdrop">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h3 style="margin:0">プレイリストに追加</h3>
                <button id="playlist-modal-close"
                    style="background:none;border:none;color:var(--text-color);font-size:20px;cursor:pointer">&times;</button>
            </div>
            <div id="playlist-modal-list"></div>
            <div style="margin-top:12px;border-top:1px solid var(--border-color);padding-top:10px;display:flex;gap:8px">
                <input id="new-playlist-input" placeholder="新規プレイリスト名"
                    style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-color)" />
                <button id="create-playlist-btn"
                    style="background:var(--ai-accent-color);border:none;padding:8px 12px;border-radius:8px;color:#fff">作成</button>
            </div>
        </div>
    </div>

    <!-- Debug UI (完成版は非表示のまま) -->
    <div id="debug-panel"><strong>Debug / Raw API</strong>
        <pre id="debug-pre"></pre>
    </div>
    <button id="debug-toggle">DEBUG</button>
</body>

</html>